/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id 'java'
    id 'org.springframework.boot' version '2.7.8'
    id 'io.spring.dependency-management' version '1.1.0'
    id 'com.google.cloud.tools.jib' version '3.3.1'
    id 'com.adarshr.test-logger' version '2.1.1'
    id 'org.liquibase.gradle' version "2.0.3"
    id "org.shipkit.shipkit-auto-version" version "1.1.1"
}

repositories {
    mavenLocal()
    mavenCentral()
}
group = 'com.lydbook.audiobook'

description = 'Lydbook'
sourceCompatibility = 11
targetCompatibility = 11

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity5:3.0.5.RELEASE'
    implementation 'nz.net.ultraq.thymeleaf:thymeleaf-layout-dialect:3.2.0'
    implementation 'org.postgresql:postgresql:42.5.3'
    implementation 'org.liquibase:liquibase-core'
    implementation 'com.mpatric:mp3agic:0.9.1'
    implementation 'org.imgscalr:imgscalr-lib:4.2'

    liquibaseRuntime 'org.springframework.boot:spring-boot-starter-data-jpa'
    liquibaseRuntime 'org.yaml:snakeyaml:1.33'
    liquibaseRuntime 'ch.qos.logback:logback-core:1.2.10'
    liquibaseRuntime 'ch.qos.logback:logback-classic:1.2.10'

    liquibaseRuntime 'org.liquibase:liquibase-core:4.19.0'
    liquibaseRuntime 'org.liquibase:liquibase-groovy-dsl:3.0.2'
    liquibaseRuntime 'org.postgresql:postgresql:42.5.3'
    liquibaseRuntime 'org.liquibase.ext:liquibase-hibernate5:4.8.0'
    liquibaseRuntime sourceSets.main.output

    runtimeOnly 'org.springframework.boot:spring-boot-devtools'
    runtimeOnly 'com.h2database:h2:2.1.214'

    testImplementation('org.springframework.boot:spring-boot-starter-test') {
        exclude group: 'org.junit.vintage', module: 'junit-vintage-engine'
    }
    testImplementation 'org.springframework.security:spring-security-test'
}

diff.dependsOn compileJava
diffChangeLog.dependsOn compileJava
generateChangelog.dependsOn compileJava

configurations {
    liquibaseRuntime.extendsFrom runtime
}

test {
    useJUnitPlatform()
}

liquibase {
    activities {
        main {
            changeLogFile 'src/main/resources/db/changelog/db.changelogs-master.yaml'
            url 'jdbc:postgresql://192.168.0.50:5444/audiobook'
            username 'book'
            password 'password'
            referenceDriver 'liquibase.ext.hibernate.database.connection.HibernateDriver'
            referenceUrl 'hibernate:spring:com.lydbook.audiobook?dialect=org.hibernate.dialect.PostgreSQL10Dialect'
        }
    }
}


springBoot {
    buildInfo {
        properties {
        }
    }
}

jib {
    from {
        image = 'openjdk:13-alpine'
    }
    to {
        image = 'shatterhand/lydbook'
        tags = ['latest', version]
        auth {
            username = 'shatterhand'
            password = "${System.env.JIB_PASSWORD}"
        }
    }
    container {
        mainClass = 'com.lydbook.audiobook.LydbookApplication'
        creationTime = 'USE_CURRENT_TIMESTAMP'
        ports = ['8080']
        environment = [POSTGRES_HOST    : '',
                       DATABASE_PORT    : '5432',
                       DATABASE_NAME    : 'audiobook',
                       DATABASE_USER    : 'book',
                       DATABASE_PASSWORD: '',

                       LOGGING_LEVEL    : 'ERROR']
    }
}