<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <meta charset="UTF-8">
    <title th:text="${book.getTitle()}">Title</title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="row">
        <div class="col-lg-6">
            <div class="bs-component">
                <div class="card mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="d-block user-select-none" width="100%"
                         aria-label="Placeholder: Image cap" focusable="false" role="img"
                         preserveAspectRatio="xMidYMid slice" viewBox="0 0 200 200"
                         style="font-size:1.125rem;text-anchor:middle">
                        <rect width="100%" height="100%" fill="#868e96"></rect>
                        <text x="50%" y="50%" fill="#dee2e6" dy=".3em" th:text="${book.getTitle()}">Image cap</text>
                    </svg>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="bs-component">
                <h2 th:text="${book.getTitle()}">Book Title</h2>
                <h4>Author: <a th:href="'/authors/'+${book.getAuthor().getId()}"
                               th:text="${book.getAuthor().getName()}"></a></h4>
                <h4 th:text="'Duration: ' + ${book.getLength()}">Duration: 15min</h4>
            </div>
        </div>
    </div>
    <div class="col-lg-12">
        <audio id="audiobook" controls="" style="width: 100%">
            <source th:src="'/api/v1/audiobook/'+${book.getId()}+'/stream'">
        </audio>
    </div>

    <div class="alert alert-secondary">
        <fieldset class="form-group">
            <input type="range" class="custom-range" id="playbackSlider" min="0" value="0" step="1">
        </fieldset>

        <div class="row">

            <div class="col-lg-3">
                <div class="center">
                    <div style="width: 100%">
                        <h5>Playbackspeed: <label id="speedDisplay">1</label></h5>
                        <input type="range" class="custom-range" id="playbspeed" min="0.5" max="3.5" value="1.0"
                               step="0.1">
                    </div>
                </div>
            </div>
            <div class="col-lg-2">
                <a href="javascript:jumpBackward();" class="center">
                    <img src="/controls/rewind.svg">
                </a>
            </div>
            <div class="col-lg-2">
                <a href="javascript:pausePlay();" class="center">
                    <img id="play" src="/controls/play.svg">
                    <img hidden id="pause" src="/controls/pause.svg">
                </a>
            </div>
            <div class="col-lg-2">
                <a href="javascript:jumpForward();" class="center">
                    <img src="/controls/forward.svg">
                </a>
            </div>
            <div class="col-lg-3">
                <div class="center">
                    <img src="/controls/volume-off.svg">
                    <input style="width: 100%" type="range" class="custom-range" min="0" max="100"
                           value="100" step="1" id="volumeSlider"/>
                    <img src="/controls/volume-up.svg">
                </div>

            </div>
        </div>
    </div>

    <script th:inline="javascript">
        let audio = $('#audiobook')[0];
        let playbackspeed = $('#playbspeed')[0];
        let volumeSlider = $('#volumeSlider')[0];

        let resumePlay = function (e) {
            e.target.removeEventListener("canplay", resumePlay, false);
            audio.currentTime = /*<![CDATA[*/ [[${progress}]]; /*]]>*/
            $('#playbackSlider').attr("max", Math.ceil(audio.duration));
            $('#playbackSlider').val(audio.currentTime);
        }

        audio.addEventListener("canplay", resumePlay)

        playbackspeed.oninput = function () {
            audio.playbackRate = playbackspeed.value;
            $('#speedDisplay').html(playbackspeed.value);
        }

        volumeSlider.oninput = function (){
            audio.volume = volumeSlider.value /100;
        }

        $('#playbackSlider')[0].oninput = function () {
            audio.currentTime = $('#playbackSlider')[0].value;
        }

        function pausePlay() {
            if (isPlaying(audio)) {
                audio.pause();
                updateCurrentTime();
                $('#pause').attr('hidden', true);
                $('#play').attr('hidden', false);
            } else {
                audio.play();
                $('#pause').attr('hidden', false);
                $('#play').attr('hidden', true);
            }
        }

        function isPlaying(aud) {
            return !aud.paused;
        }

        function jumpForward() {
            let forwardTime = audio.currentTime + 30;
            if (forwardTime < Math.ceil(audio.duration)) {
                audio.currentTime = forwardTime;
            } else {
                audio.currentTime = Math.ceil(audio.duration) - 1;
            }
        }

        function jumpBackward() {
            let backwardTime = audio.currentTime - 30;
            if (backwardTime > 0) {
                audio.currentTime = backwardTime;
            } else {
                audio.currentTime = 0;
            }
        }

        function updateSlider() {
            audio.currentTime = $('#playbackSlider')[0].value;
        }

        audio.addEventListener("oninput", updateSlider)

        // audio.addEventListener("timeupdate", updateSlider)


        function updateCurrentTime() {
            // $.ajax({
            //     type: "POST"
            // })
            console.log(audio.readyState);
        }


        function getTimeHHMMSS(seconds) {
            let s = seconds % 60;
            let m = ((seconds - s) / 60) % 60;
            let h = (seconds - s - m * 60) / 3600;


            return format(h) + ":" + format(m) + ":" + format(s);
        }

        function format(i) {
            if (i < 10) {
                return '0' + i;
            } else {
                return i;
            }
        }

        $(function () {
            setInterval(updateCurrentTime, 10000);
        });
    </script>
</th:block>
</body>
</html>