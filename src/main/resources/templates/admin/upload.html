<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <meta charset="UTF-8">
    <title>Uploads</title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="row">
        <div class="col-lg-12">
            <div class="page-header">
                <h1>Upload Audiobooks</h1>
            </div>
        </div>
        <div class="col-lg-12">
            <div class="bs-component">
                <div class="alert alert-dismissible alert-warning">
                    <h4 class="alert-heading">Note</h4>
                    <p class="mb-0">Audiobooks that have varying album names (example "Song of Ice and Fire CD 1 / ...
                        CD 2" and so on must be packed in a zip file. Or be uploaded using the varying album name
                        switch</p>
                </div>
            </div>
            <div class="form-group" id="uploadInput">
                <div class="custom-control custom-switch">
                    <input name="shareAll" type="checkbox" class="custom-control-input" id="newusershareAll"
                    >
                    <label class="custom-control-label" for="newusershareAll">Single Audiobook with varying album
                        names.</label>
                </div>
                <form th:action="@{/api/v1/audiobook}" method="post" enctype="multipart/form-data"
                      class="input-group mb-3" id="uploadForm">
                    <div class="custom-file">
                        <input name="data" type="file" accept=".mp3" class="custom-file-input" id="inputGroupFile">
                        <label class="custom-file-label" for="inputGroupFile">Choose a mp3 file</label>
                    </div>
                    <div class="input-group-append">
                        <input type="submit" value="Upload" class="input-group-text" id="uploadBtn"/>
                    </div>
                </form>
            </div>
            <div class="form-group">
                <div class="bs-component">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="25"
                             aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <script>
            // Add the following code if you want the name of the file appear on select
            $(".custom-file-input").on("change", function () {
                var fileName = $(this).val().split("\\").pop();
                $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
            });
            $(document).ready(function () {

                $("#uploadBtn").click(function (event) {

                    //stop submit the form, we will post it manually.
                    event.preventDefault();
                    // Create an FormData object
                    var data = new FormData($('#uploadForm')[0]);
                    // disabled the submit button
                    $("#uploadInput").prop("hidden", true);

                    $.ajax({
                        type: "POST",
                        enctype: 'multipart/form-data',
                        url: "/api/v1/audiobook",
                        data: data,
                        processData: false,
                        contentType: false,
                        cache: false,
                        timeout: 600000,
                        xhr: function () {
                            var xhr = $.ajaxSettings.xhr();
                            if (xhr.upload) {
                                xhr.upload.addEventListener('progress', function (event) {
                                    var percent = 0;
                                    if (event.lengthComputable) {
                                        percent = Math.ceil((event.loaded || event.position) / event.total * 100);
                                    }
                                    $(".progress-bar").css("width", +percent + "%");
                                    // $(".status").text(percent + "%");
                                }, true);
                            }
                            return xhr;
                        },
                        success: function (mdata) {
                            if (mdata == 0) {
                                alert("Done");
                            }

                        },
                    });
                });
            });

        </script>
</th:block>
</body>
</html>